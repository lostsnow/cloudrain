jQuery(function(e){var t=new AnsiUp,o=e("#terminal-box"),n=e("#prompt-input"),s=function(e){var t=o.scrollTop()+40>=o[0].scrollHeight-o.height();o.append(e),t&&o.scrollTop(o[0].scrollHeight-o.height())};if("WebSocket"in window){var c=new Tomato.WebSocketClient,a=Tomato.websocketUrl,i=e(".prompt .connection i");c.open(a),c.onopen=function(){s('<p class="text-success">Connected.</p>'),i.removeClass("red").addClass("green").attr("title","Connected")},c.onmessage=function(e){if(""!==e.data)try{var o=JSON.parse(e.data);switch(o.event){case"text":e=t.ansi_to_html(o.content),s(e);break;case"session":try{var n=JSON.parse(o.content);if(!n.sid||!n.token)return s("Invalid websocket session"),c.autoReconnectInterval=0,void c.close(1e3);Tomato.cookie.set("sessionid",n.sid),Tomato.cookie.set("token",n.token);var a=Tomato.GetUrlParameter("sid");a&&n.sid!==a&&window.history.pushState("","",location.href.replace("sid="+a,"sid="+n.sid))}catch(e){s("Invalid websocket response"),c.autoReconnectInterval=0,c.close(1e3)}break;case"ping":console.log("ping...");break;case"mssp":console.log("mssp:",o.content);break;case"atcp":console.log("atcp");break;case"mxp":console.log("mxp")}}catch(e){console.log(e)}},c.onclose=function(){s('<p class="text-danger">Disconnected.</p>'),i.removeClass("green").addClass("red").attr("title","Disconnected")},c.onerror=function(){s('<p class="text-danger">Error connecting.</p>')},c.onreconnect=function(e){e=Math.floor(e/1e3),s('<p class="text-warning">Reconnecting in '+e+" seconds.</p>")},i.on("click",function(){e(this).hasClass("red")?c.open(a):e(this).hasClass("green")&&c.close(1e3)}),o.on("mouseup",function(){var e;window.getSelection?e=window.getSelection():document.selection&&(e=document.selection.createRange()),""!==e.toString()?Tomato.CopySelect():n.trigger("focus")}),n.inputHistory({size:50,ignoreEmpty:!0}),n.on("keyup",function(e){if("Enter"===e.key&&!e.shiftKey){var t={type:"cmd",content:this.value+"\n"};try{s(Tomato.EscapeHtml(t.content)),c.send(JSON.stringify(t))}catch(e){s('<p class="text-warning">Couldn\'t send message.</p>')}this.value="",e.stopPropagation()}})}else s("Requires a browser with WebSockets support.")});